(()=>{"use strict";const e=window.React,n=window.wp.i18n,t=window.wp.plugins,i=window.wp.editor,a=window.wp.components,s=window.wp.data,o=window.wp.compose,l=window.wp.element,p=(0,o.compose)([(0,s.withSelect)(e=>({meta:e("core/editor").getEditedPostAttribute("meta")})),(0,s.withDispatch)(e=>({setMeta(n){e("core/editor").editPost({meta:n})}}))])(({meta:t,setMeta:o})=>{const p=(0,s.useSelect)(e=>e("core/editor").getCurrentPost().status,[]),[r,c]=(0,l.useState)(!1),[g,d]=(0,l.useState)(null),[_,u]=(0,l.useState)(null),[m,w]=(0,l.useState)(null),[f,h]=(0,l.useState)(null),{all_segments:S,default_segments:b}=window.appsignalOneSignalData,{createNotice:y}=(0,s.useDispatch)("core/notices"),{savePost:x}=(0,s.useDispatch)("core/editor"),E=(0,l.useRef)(p);if((0,l.useEffect)(()=>{"publish"!==E.current&&"publish"===p&&(console.log("Post was published!"),P()),E.current=p},[p]),(0,l.useEffect)(()=>{t&&void 0===t.appsignal_notification_segments&&o({...t,appsignal_notification_segments:b})},[t]),!t)return null;const P=async()=>{const e=t.appsignal_notification_title||"",i=t.appsignal_notification_message||"";let a=!1;if(e.trim()?u(null):(u((0,n.__)("Title is required.","apppresser-onesignal")),a=!0),i.trim()?w(null):(w((0,n.__)("Message is required.","apppresser-onesignal")),a=!0),!a){c(!0),d(null);try{if(await x(),!(await window.fetch(`${window.appsignalOneSignalData?.rest_url}appsignal/v1/send`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.appsignalOneSignalData?.nonce||""},body:JSON.stringify({post_id:window.appsignalOneSignalData?.post_id||0})})).ok)throw new Error("Failed to send notification");d("success"),y("success",(0,n.__)("Push notification sent successfully!","apppresser-onesignal"),{id:"appsignal-notice",isDismissible:!0})}catch(e){console.error("Error sending push notification:",e),d("error"),y("error",(0,n.__)("Failed to send push notification. Please try again.","apppresser-onesignal"),{id:"appsignal-notice",isDismissible:!0})}finally{c(!1)}}};return(0,e.createElement)(i.PluginDocumentSettingPanel,{name:"appsignal-document-setting-panel",title:(0,n.__)("Push Notification","apppresser-onesignal")},(0,e.createElement)(a.ToggleControl,{label:(0,n.__)("Send push notification","apppresser-onesignal"),checked:t.appsignal_send_notification,onChange:e=>{o({...t,appsignal_send_notification:e})},disabled:!t.appsignal_notification_title||!t.appsignal_notification_message||"publish"===p,help:(0,n.__)("A notification will be sent when this post is published.","apppresser-onesignal")}),(0,e.createElement)(a.TextControl,{label:(0,n.__)("Title","apppresser-onesignal"),value:t.appsignal_notification_title||"",onChange:e=>{o({...t,appsignal_notification_title:e}),e.trim()&&u(null)},maxLength:30,help:`${(t.appsignal_notification_title||"").length}/30`}),_&&(0,e.createElement)("div",{style:{color:"#d63638",marginTop:"-10px",fontSize:"12px",marginBottom:"10px"}},_),(0,e.createElement)(a.TextareaControl,{label:(0,n.__)("Message","apppresser-onesignal"),value:t.appsignal_notification_message||"",onChange:e=>{o({...t,appsignal_notification_message:e}),e.trim()&&w(null)},maxLength:60,help:`${(t.appsignal_notification_message||"").length}/60`}),m&&(0,e.createElement)("div",{style:{color:"#d63638",marginTop:"-10px",fontSize:"12px",marginBottom:"10px"}},m),(0,e.createElement)("h2",{style:{fontSize:"14px",marginTop:"20px",marginBottom:"8px"}},(0,n.__)("Segments","apppresser-onesignal")),S&&Object.entries(S).map(([n,i])=>(0,e.createElement)(a.CheckboxControl,{key:n,label:i,checked:(t.appsignal_notification_segments||[]).includes(n),onChange:e=>{const i=t.appsignal_notification_segments||[],a=e?[...i,n]:i.filter(e=>e!==n);o({...t,appsignal_notification_segments:a})}})),(0,e.createElement)(a.PanelRow,null,(0,e.createElement)("div",{style:{width:"100%"}},(0,e.createElement)(a.Button,{variant:"secondary",onClick:P,isBusy:r,disabled:r,style:{marginTop:"16px",width:"100%",textAlign:"center",display:"flex",justifyContent:"center"}},r?(0,n.__)("Sending...","apppresser-onesignal"):(0,n.__)("Send Push","apppresser-onesignal")))))});(0,t.registerPlugin)("appsignal-document-setting-panel",{render:p})})();